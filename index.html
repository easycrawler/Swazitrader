<script>
  // üåó Theme toggle with memory
  (function() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') document.body.classList.add('dark');
  })();

  function toggleTheme() {
    document.body.classList.toggle('dark');
    const theme = document.body.classList.contains('dark') ? 'dark' : 'light';
    localStorage.setItem('theme', theme);
  }

  // üõçÔ∏è Shopify Integration with Load More
  const shopDomain = "Swazitraderg0btje-sf.myshopify.com"; // Your Shopify domain
  const storefrontAccessToken = "39a497754e16d8c077eb3d8f46e99c48"; // Your token

  let productsContainer = document.getElementById("products");
  let cursor = null; // Tracks last product for pagination
  let hasNextPage = true;

  async function loadShopifyProducts(limit = 12) {
    if (!hasNextPage) return;

    const query = `
      {
        products(first: ${limit}${cursor ? `, after: "${cursor}"` : ''}) {
          edges {
            cursor
            node {
              id
              title
              description
              images(first: 1) { edges { node { src } } }
              variants(first: 1) { edges { node { price { amount } } } }
            }
          }
          pageInfo {
            hasNextPage
          }
        }
      }
    `;

    const response = await fetch(`https://${shopDomain}/api/2023-07/graphql.json`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Shopify-Storefront-Access-Token": storefrontAccessToken
      },
      body: JSON.stringify({ query })
    });

    const data = await response.json();

    if (!data.data || !data.data.products) {
      productsContainer.innerHTML = "<p>‚ö†Ô∏è Could not load products. Check your token or store domain.</p>";
      return;
    }

    data.data.products.edges.forEach(edge => {
      const p = edge.node;
      cursor = edge.cursor; // Update cursor
      const imageUrl = p.images.edges[0]?.node?.src || "https://via.placeholder.com/300x200";
      const price = p.variants.edges[0]?.node?.price.amount || "0.00";

      const productHTML = `
        <div class="product">
          <img src="${imageUrl}" alt="${p.title}">
          <div class="product-content">
            <h3>${p.title}</h3>
            <p>${p.description || "No description available"}</p>
            <p class="price">$${price}</p>
            <button>Add to Cart</button>
          </div>
        </div>
      `;
      productsContainer.innerHTML += productHTML;
    });

    hasNextPage = data.data.products.pageInfo.hasNextPage;
    // Show or hide the Load More button
    if (hasNextPage) {
      if (!document.getElementById("loadMoreBtn")) {
        const btn = document.createElement("button");
        btn.id = "loadMoreBtn";
        btn.textContent = "Load More Products";
        btn.style.display = "block";
        btn.style.margin = "20px auto";
        btn.style.padding = "10px 20px";
        btn.style.backgroundColor = "#28a745";
        btn.style.color = "#fff";
        btn.style.border = "none";
        btn.style.borderRadius = "5px";
        btn.style.cursor = "pointer";
        btn.onclick = () => loadShopifyProducts();
        productsContainer.after(btn);
      }
    } else {
      const btn = document.getElementById("loadMoreBtn");
      if (btn) btn.style.display = "none";
    }
  }

  // üöÄ Load first batch on page load
  window.addEventListener("DOMContentLoaded", () => loadShopifyProducts());

  // üîç Search functionality
  function filterProducts() {
    const term = document.getElementById("searchInput").value.toLowerCase();
    document.querySelectorAll(".product").forEach(p => {
      const title = p.querySelector("h3").innerText.toLowerCase();
      p.style.display = title.includes(term) ? "block" : "none";
    });
  }
</script>
